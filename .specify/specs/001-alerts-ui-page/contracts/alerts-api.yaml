openapi: 3.0.3
info:
  title: Alerts API
  description: |
    REST API for retrieving trading alerts generated by the saxo-order alerting system.
    Alerts are automatically generated daily and stored in DynamoDB with 7-day TTL.
  version: 1.0.0
  contact:
    name: saxo-order
    url: https://github.com/RNiveau/saxo-order

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.production.example.com
    description: Production server (TBD)

tags:
  - name: alerts
    description: Trading alert operations

paths:
  /api/alerts:
    get:
      tags:
        - alerts
      summary: Get all alerts
      description: |
        Retrieves all active alerts from the last 7 days. Alerts are automatically
        expired by DynamoDB TTL, so only alerts created within the last 7 days are returned.

        Supports optional filtering by asset_code and alert_type via query parameters.
        Results are sorted by date descending (newest first).
      operationId: getAllAlerts
      parameters:
        - name: asset_code
          in: query
          description: Filter alerts by specific asset code (e.g., "ITP", "BTCUSDT")
          required: false
          schema:
            type: string
            example: ITP
        - name: alert_type
          in: query
          description: Filter alerts by specific alert type
          required: false
          schema:
            type: string
            enum:
              - congestion20
              - congestion100
              - combo
              - double_top
              - double_inside_bar
              - containing_candle
            example: combo
        - name: country_code
          in: query
          description: Filter alerts by exchange/country code (e.g., "xpar", "xnas", or empty for crypto)
          required: false
          schema:
            type: string
            example: xpar
      responses:
        '200':
          description: Successful response with alerts list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertsResponse'
              examples:
                multipleAlerts:
                  summary: Multiple alerts for different assets
                  value:
                    alerts:
                      - id: "ITP_xpar"
                        alert_type: "combo"
                        asset_code: "ITP"
                        country_code: "xpar"
                        date: "2026-01-10T18:15:00"
                        data:
                          price: 150.25
                          direction: "Buy"
                          strength: "Strong"
                          has_been_triggered: false
                        age_hours: 12
                      - id: "BTCUSDT"
                        alert_type: "double_top"
                        asset_code: "BTCUSDT"
                        country_code: null
                        date: "2026-01-09T14:30:00"
                        data:
                          close: 45000.0
                          open: 44800.0
                          higher: 45200.0
                          lower: 44700.0
                        age_hours: 40
                    total_count: 2
                    available_filters:
                      asset_codes: ["ITP", "BTCUSDT", "AAPL"]
                      alert_types: ["combo", "double_top", "congestion20"]
                      country_codes: ["xpar", "xnas", ""]
                emptyResult:
                  summary: No alerts found
                  value:
                    alerts: []
                    total_count: 0
                    available_filters:
                      asset_codes: []
                      alert_types: []
                      country_codes: []
        '400':
          description: Bad request - invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "Invalid alert_type value. Must be one of: congestion20, congestion100, combo, double_top, double_inside_bar, containing_candle"
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "Authentication credentials were not provided"
        '503':
          description: Service unavailable - DynamoDB or AWS service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "Service temporarily unavailable. Please try again later."

components:
  schemas:
    AlertItemResponse:
      type: object
      required:
        - id
        - alert_type
        - asset_code
        - date
        - data
        - age_hours
      properties:
        id:
          type: string
          description: Composite identifier (asset_code_country_code or just asset_code)
          example: "ITP_xpar"
        alert_type:
          type: string
          description: Type of alert pattern detected
          enum:
            - congestion20
            - congestion100
            - combo
            - double_top
            - double_inside_bar
            - containing_candle
          example: "combo"
        asset_code:
          type: string
          description: Asset symbol or ticker
          example: "ITP"
        country_code:
          type: string
          nullable: true
          description: Exchange or country code (null for crypto assets)
          example: "xpar"
        date:
          type: string
          format: date-time
          description: ISO 8601 timestamp when alert was generated
          example: "2026-01-10T18:15:00"
        data:
          type: object
          description: Alert-specific data payload (structure varies by alert_type)
          additionalProperties: true
          example:
            price: 150.25
            direction: "Buy"
            strength: "Strong"
        age_hours:
          type: integer
          description: Hours since alert was generated (calculated field)
          minimum: 0
          maximum: 168
          example: 12

    AlertsResponse:
      type: object
      required:
        - alerts
        - total_count
        - available_filters
      properties:
        alerts:
          type: array
          description: List of alert items
          items:
            $ref: '#/components/schemas/AlertItemResponse'
        total_count:
          type: integer
          description: Total number of alerts returned (after filtering)
          minimum: 0
          example: 42
        available_filters:
          type: object
          description: Available filter values based on current data
          required:
            - asset_codes
            - alert_types
            - country_codes
          properties:
            asset_codes:
              type: array
              description: List of unique asset codes present in alerts
              items:
                type: string
              example: ["ITP", "AAPL", "GOOGL", "BTCUSDT"]
            alert_types:
              type: array
              description: List of unique alert types present in alerts
              items:
                type: string
              example: ["combo", "congestion20", "double_top"]
            country_codes:
              type: array
              description: List of unique country codes present in alerts (empty string for crypto)
              items:
                type: string
              example: ["xpar", "xnas", ""]

    ErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Human-readable error message
          example: "Service temporarily unavailable"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authentication (implementation TBD)

security:
  - bearerAuth: []
